@using Invoices.Blazor.Services
@using Invoices.Shared.Models.Person
@using Invoices.Shared.Models.Common
@using Invoices.Blazor.Validation
@using Invoices.Blazor.Validation.Specific
@using Invoices.Blazor.Validation.Rules
@using Invoices.Blazor.InputHandlers
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<PersonForm> L
@inject LanguageService Lang
@inject FormFieldBlurTracker BlurTracker

<MudForm @ref="form" Model="Person">
    <MudStack Spacing="8">

        <MudTextField Value="@Person.Name"
                      ValueChanged="@((string v) => 
                            Person.Name = TextInputHandler.Handle(v, new TextInputOptions {
                                Trim = true,
                                CollapseWhitespace = true,
                                Casing = TextCasing.Title,
                                MaxLength = 50
                            }))"
                      Label="@L["Name"]"
                      Required="true"
                      Immediate="true"
                      Validation="@Validator.ValidateAll(
                            Validator.Required("Name"),
                            Validator.MaxLength("Name", 50)
                      )" />

        <MudTextField Value="@Person.IdentificationNumber"
                      ValueChanged="@((string v) => 
                            Person.IdentificationNumber = NumbersInputHandler.Handle(v, new[] { 8 }))"
                      Label="@L["IdentificationNumber"]"
                      Required="true"
                      Immediate="true"
                      InputType="InputType.Text"
                      Validation="@Validator.ValidateAll(
                              Validator.Required("IdentificationNumber"),
                              Validator.DigitsExactLengthAfterBlurAsync("IdentificationNumber", 8),
                              Validator.Format("IdentificationNumber", @"^\d{8}$", 8)
                          )"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Badge"
                      OnFocus="@(() => BlurTracker.MarkFocused("IdentificationNumber"))"
                      OnBlur="@(() => BlurTracker.MarkBlurred("IdentificationNumber"))"
                      Disabled="IsEdit" />

        <MudTextField @bind-Value="Person.TaxNumber"
                      Label="@L["TaxNumber"]"
                      Required="true"
                      Immediate="true"
                      Validation=@Validator.Required("TaxNumber")
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Receipt" />

<MudTextField Value="@Person.AccountNumber"
              ValueChanged="@((string v) =>
                    Person.AccountNumber = NumbersInputHandler.Handle(v, new[] { 10 }))"
              Label="@L["AccountNumber"]"
              Required="true"
              Immediate="true"
              InputType="InputType.Text"
                Validation="@Validator.ValidateAll(
                    Validator.Required("AccountNumber"),
                    Rules.AfterBlur("AccountNumber",
                        Validator.MinLength("AccountNumber", 6),
                        BlurTracker
                    ),
                    Validator.MaxLength("AccountNumber", 10),
                    Validator.Format("AccountNumber", @"^\d{6,10}$", 10),
                    AccountValidator.ValidateAfterBlur("AccountNumber")
                )"

              Adornment="Adornment.Start"
              AdornmentIcon="@Icons.Material.Filled.AccountBalance"
              OnFocus="@(() => BlurTracker.MarkFocused("AccountNumber"))"
              OnBlur="@(() => BlurTracker.MarkBlurred("AccountNumber"))" />


        <MudTextField Value="@Person.BankCode"
                      ValueChanged="@((string v) => 
                      Person.BankCode = NumbersInputHandler.Handle(v, new[] { 4 }))"
                      Label="@L["BankCode"]"
                      Required="true"
                      Immediate="true"
                      InputType="InputType.Text"
                       Validation="@Validator.ValidateAll(
                      Validator.Required("BankCode"),
                      Validator.MaxLength("BankCode", 4),
                      Validator.DigitsExactLengthAfterBlurAsync("BankCode", 4)
                  )"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Numbers"
              OnFocus="@(() => BlurTracker.MarkFocused("BankCode"))"
              OnBlur="@(() => BlurTracker.MarkBlurred("BankCode"))" />

        <MudTextField  Value="@Person.Iban"
                      ValueChanged="@((string v) => 
                      Person.Iban = NumbersInputHandler.Handle(v, new[] { 24 }))"
                      Label="@L["Iban"]"
                      Required="true"
                      Immediate="true"
                      Validation="@Validator.ValidateAll(
                              Validator.Required("Iban"),
                              Validator.DigitsExactLengthAfterBlurAsync("Iban", 24),
                              Validator.Format("Iban", @"^[A-Z0-9]{24}$", 24)
      
                          )"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Language"
                      OnFocus="@(() => BlurTracker.MarkFocused("Iban"))"
                      OnBlur="@(() => BlurTracker.MarkBlurred("Iban"))" />

        <MudTextField Value="@Person.Telephone"
                      ValueChanged="@((string v) => Person.Telephone = NumbersInputHandler.Handle(v, new[] { 3, 3, 3 }))"
                      Label="@L["Telephone"]"
                      Required="true"
                      Immediate="true"
                      InputType="InputType.Text"
                      Validation="@Validator.ValidateAll(
                              Validator.Required("Telephone"),
                              Validator.DigitsExactLengthAfterBlurAsync("Telephone", 9),
                              Validator.Format("Telephone", @"^\d{3}\s\d{3}\s\d{3}$", 9)      
                          )"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Phone"
                      OnFocus="@(() => BlurTracker.MarkFocused("Telephone"))"
                      OnBlur="@(() => BlurTracker.MarkBlurred("Telephone"))" />

        <MudTextField @bind-Value="Person.Mail"
                      Label="@L["Mail"]"
                      Required="true"
                      Immediate="true"
                      InputType="InputType.Email"
                      Validation=@Validator.Required("Mail")
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Email" />

        <MudTextField @bind-Value="Person.Street"
                      Label="@L["Street"]"
                      Required="true"
                      Immediate="true"
                      Validation=@Validator.Required("Street")
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Home" />

        <MudTextField @bind-Value="Person.Zip"
                      Label="@L["Zip"]"
                      Required="true"
                      Immediate="true"
                      InputType="InputType.Number"
                      Validation=@Validator.Required("Zip")
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.MarkunreadMailbox" />

        <MudTextField @bind-Value="Person.City"
                      Label="@L["City"]"
                      Required="true"
                      Immediate="true"
                      Validation=@Validator.Required("City")
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.LocationCity" />

        <MudSelect T="Country ?"
                   Label="@L["Country"]"
                   @bind-Value="Person.Country"
                   Required="true"
                   Immediate="true"
                   Validation="@(Validator.Required<Country?>("Country"))"
                   Adornment="Adornment.Start"
                   AdornmentIcon="@Icons.Material.Filled.Public">
            <MudSelectItem T="Country ?" Value="@(null)">Vyberte stát</MudSelectItem>
            @foreach (var country in Enum.GetValues<Country>())
            {
                <MudSelectItem T="Country ?" Value="country">@GetCountryAlias(country)</MudSelectItem>
            }
        </MudSelect>

        <MudTextField @bind-Value="Person.Note"
                      Label="@L["Note"]"
                      Immediate="true"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Note" />

        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   OnClick="SubmitInternal">
            @(IsEdit ? "Uložit změny" : "Vytvořit")
        </MudButton>

    </MudStack>
</MudForm>

@code {

    // TODO: Refactor, use DI instead of creating new instances
    private MudForm? form;
    private FormValidator Validator;
    private AccountNumberModulo11Validator AccountValidator;
    private RulesValidator Rules;

    [Parameter] public PersonDto Person { get; set; } = new();
    [Parameter] public bool IsEdit { get; set; }
    [Parameter] public EventCallback<PersonDto> OnSubmit { get; set; }

    protected override void OnInitialized()
    {
        Validator = new FormValidator(L, BlurTracker);
        AccountValidator = AccountNumberModulo11Validator.Create(L, BlurTracker);
        Lang.OnChange += Refresh;
    }

    private async Task SubmitInternal()
    {
        await form.Validate();

        if (!form.IsValid)
            return;

        await OnSubmit.InvokeAsync(Person);
    }

    private string GetCountryAlias(Country country)
    {
        return L[country.ToString()];
    }

    private void Refresh()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Lang.OnChange -= Refresh;
    }
}
